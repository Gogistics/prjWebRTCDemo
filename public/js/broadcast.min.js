/*! webrtc 20-10-2016 */!function($){function initApp(){window.broadcastApp=window.broadcastApp||angular.module("broadcastApp",[],function($locationProvider,$interpolateProvider){$locationProvider.html5Mode(!0),$interpolateProvider.startSymbol("[["),$interpolateProvider.endSymbol("]]")}),window.broadcastApp.value("APP_VALUES",{EMAIL:"gogistics@gogistics-tw.com",MEDIA_CONFIG:{audio:!0,video:{mandatory:{minWidth:1280,minHeight:720,maxWidth:1280,maxHeight:720,frameRate:{min:35,ideal:50,max:60}}}},BINARY_STREAM:null,FINGERPRINT:null}),window.broadcastApp.config(function(){}),window.broadcastApp.run(function(){}),window.broadcastApp.service("dataProvider",function($http,APP_VALUES){this.getStreams=function(arg_url,arg_headers,arg_data){return $http({url:arg_url,method:"POST",data:arg_data,headers:arg_headers})}}),window.broadcastApp.factory("client",function(){return new PeerManager("broadcast")}),window.broadcastApp.factory("binaryjsClient",function(){return new BinaryClient("ws://45.79.106.150:8888")}),window.broadcastApp.factory("fingerprintManager",function(){return new Fingerprint}),window.broadcastApp.factory("camera",["$window","$rootScope","client","APP_VALUES",function($window,$rootScope,client,APP_VALUES){var camera={};return camera.preview=$window.document.getElementById("localVideo"),camera.isOn=!1,camera.start=function(){return requestUserMedia(APP_VALUES.MEDIA_CONFIG).then(function(stream){attachMediaStream(camera.preview,stream),client.setLocalStream(stream),camera.stream=stream,camera.isOn=!0,$rootScope.$broadcast("cameraIsOn",!0),console.log("OnSuccess...")},function(err){console.log("OnError...")}).catch(Error("Failed to get access to local media"))},camera.stop=function(){return new Promise(function(resolve,reject){try{camera.stream.stop(),camera.preview.src="",resolve()}catch(err){reject(err)}}).then(function(result){camera.isOn=!1,$rootScope.$broadcast("cameraIsOn",!1)})},camera}]),window.broadcastApp.controller("broadcastCtrl",["$scope","$window","APP_VALUES","dataProvider","client","binaryjsClient","camera","fingerprintManager",function($scope,$window,APP_VALUES,dataProvider,client,binaryjsClient,camera,fingerprintManager){APP_VALUES.FINGERPRINT=fingerprintManager.get(),$scope.$on("cameraIsOn",function(event,data){console.log(data),$scope.$apply(function(){ctrl.cameraIsOn=data})});var ctrl=this;ctrl.link="",ctrl.cameraIsOn=!1,ctrl.userType=null,ctrl.watchers=[],ctrl.init=function(arg_user_type){ctrl.userType=arg_user_type},ctrl.toggleCam=function(){ctrl.cameraIsOn?(ctrl.stopRecording(),camera.stop().then(function(result){client.send("leave",{name:ctrl.name,user_type:"broadcast"}),client.setLocalStream(null),$window.location.reload()}).catch(function(err){console.log(err)})):(console.log("start camera..."),camera.start().then(function(result){ctrl.link=$window.location.host+"/"+client.getId(),ctrl.name=client.getId(),client.send("readyToStream",{name:ctrl.name,user_type:ctrl.userType}),binaryjsClient.on("open",function(stream){console.log(stream)})}))},ctrl.getWatchers=function(){var customHeaders={current_cookie:$window.document.cookie,"Content-Type":"application/json"};dataProvider.getStreams("/get-watchers",customHeaders,{id:client.getId()}).success(function(data,status,headers,config){console.log(data),ctrl.watchers=data.servedWatchers}).error(function(data,status,headers,config){console.log(data)})},client.addExternalMechanism("load_watchers",ctrl.getWatchers),ctrl.isRecording=!1,ctrl.startRecording=function(){if(!ctrl.isRecording){ctrl.isRecording=!ctrl.isRecording;var from="broadcast-"+client.getId();APP_VALUES.BINARY_STREAM=binaryjsClient.createStream({from:from}),APP_VALUES.BINARY_STREAM.on("data",function(data){console.log(data)}),ctrl.startTimestamp=(new Date).getTime(),ctrl.rtcRecorder=RecordRTC(camera.stream,{bufferSize:16384,type:"video",frameInterval:20},function(arg_data){var arrayBuffer,uint16Array,fileReader=new FileReader;fileReader.onload=function(){arrayBuffer=this.result,uint16Array=new Uint16Array(arrayBuffer,0,arrayBuffer.length-1),APP_VALUES.BINARY_STREAM&&uint16Array?(APP_VALUES.BINARY_STREAM.write(uint16Array),console.log(uint16Array)):console.log(arrayBuffer)},fileReader.readAsArrayBuffer(arg_data)}),ctrl.rtcRecorder.startRecording()}},ctrl.stopRecording=function(){if(ctrl.isRecording){ctrl.isRecording=!ctrl.isRecording,APP_VALUES.BINARY_STREAM.end(),ctrl.stopTimestamp=(new Date).getTime();var fileName=ctrl.name+"-"+ctrl.startTimestamp+"_"+ctrl.stopTimestamp;ctrl.rtcRecorder.stopRecording(),ctrl.rtcRecorder.save(fileName)}}}])}angular.element(document).ready(function(){angular.bootstrap(document.body,["broadcastApp"])}),initApp()}(jQuery);