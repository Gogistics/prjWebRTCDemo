/*! webrtc 20-10-2016 */"use strict";var PeerManager=function(arg_user_type){function initLocalPeer(){var localPeer=new LocalPeer(config.peerConnectionConfig,config.peerConnectionConstraints),dataChannelOptions={maxRetransmitTime:5e3},dataChannel=localPeer.pc.createDataChannel("myChannel",dataChannelOptions);return dataChannel.binaryType="arraybuffer",dataChannel.onerror=function(error){console.log("Data Channel Error:",error)},dataChannel.onmessage=function(event){console.log("Got Data Channel Message:",event.data)},dataChannel.onopen=function(){console.log("The Data Channel is open..."),dataChannel.send("Hello World!")},dataChannel.onclose=function(){console.log("The Data Channel is Closed")},localPeer}function addPeer(remoteId,arg_usertype){var peer=new RemotePeer(config.peerConnectionConfig,config.peerConnectionConstraints,remoteId,arg_usertype);return peer.pc.onicecandidate=function(event){event.candidate&&send("candidate",remoteId,{label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate})},peer.pc.onaddstream=function(event){attachMediaStream(peer.remoteVideoEl,event.stream),remoteVideosContainer.appendChild(peer.remoteVideosDiv),remoteStreamsDB[peer.remoteVideoEl.id]=event.stream},peer.pc.ontrack=function(){attachMediaStream(peer.remoteVideoEl,event.stream),remoteVideosContainer.appendChild(peer.remoteVideosDiv),remoteStreamsDB[peer.remoteVideoEl.id]=event.stream},peer.pc.onremovestream=function(event){try{remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideosDiv)&&remoteVideosContainer.removeChild(peer.remoteVideosDiv)}catch(err){console.log(err)}},peer.pc.oniceconnectionstatechange=function(event){switch((event.srcElement||event.target).iceConnectionState){case"disconnected":try{remoteVideosContainer&&remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideosDiv)&&remoteVideosContainer.removeChild(peer.remoteVideosDiv)}catch(err){console.log(err)}}},peer.pc.removeStream=function(){peer.pc.getSenders().forEach(function(sender){console.log("<---sender at removeStream--->"),console.log(sender);try{peer.pc.removeTrack(sender),remoteVideosContainer&&remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideosDiv)&&remoteVideosContainer.removeChild(peer.remoteVideosDiv)}catch(err){console.log(err)}})},peerDatabase[remoteId]=peer,peer}function answer(remoteId){var pc=peerDatabase[remoteId].pc;pc.createAnswer(function(sessionDescription){pc.setLocalDescription(sessionDescription),send("answer",remoteId,sessionDescription)},error,setSdpConstraints())}function offer(remoteId){var pc=peerDatabase[remoteId].pc;pc.createOffer(function(sessionDescription){pc.setLocalDescription(sessionDescription),send("offer",remoteId,sessionDescription)},error,setSdpConstraints())}function addWatcher(remoteId){console.log("<--- addWatcher broadcast info. --->"),console.log(remoteId),socket.emit("addWatcher",{localId:localId,remoteId:remoteId,userType:userType})}function removeWatcherIdFromDB(remoteId){console.log("<--- remove watcher from broadcast doc. --->"),console.log(remoteId),socket.emit("removeWatcher",{localId:localId,remoteId:remoteId,userType:userType})}function setSdpConstraints(){return navigator.mozGetUserMedia?{offerToReceiveAudio:1,offerToReceiveVideo:1}:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}function handleMessage(message){var type=message.type,from=message.from,pc=(peerDatabase[from]||addPeer(from,userType)).pc;switch(console.log("<---handleMessage--->"),console.log("received "+type+" from "+from),console.log(message),console.log("<---end of handleMessage--->"),type){case"init":toggleLocalStream(pc),offer(from),addWatcher(from);break;case"remove":removeStream(pc),removeWatcherIdFromDB(from),offer(from);break;case"offer":message.payload&&pc.setRemoteDescription(new RTCSessionDescription(message.payload)).then(function(){console.log("successfully receive offer")}).catch(error),answer(from);break;case"answer":message.payload&&pc.setRemoteDescription(new RTCSessionDescription(message.payload)).then(function(){console.log("successfully receive offer")}).catch(error);break;case"candidate":pc.remoteDescription&&pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:message.payload.label,sdpMid:message.payload.id,candidate:message.payload.candidate})).then(function(){}).catch(error)}}function send(type,to,payload){console.log("<---send--->"),console.log("sending "+type+" to "+to),console.log(payload),console.log("<---end of send--->"),socket.emit("message",{to:to,type:type,payload:payload})}function toggleLocalStream(pc){console.log("<---toggleLocalStream--->"),console.log(pc.getLocalStreams),localStream&&(pc.getLocalStreams().length?pc.removeStream():pc.addStream(localStream))}function removeStream(pc){console.log("<---removeStream--->"),localStream&&pc.getLocalStreams().length&&(console.log(pc.getLocalStreams()),pc.removeStream())}function error(err){console.log(err)}var localId,localStream,userType=arg_user_type,config={peerConnectionConfig:{iceServers:[{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun.anyfirewall.com:3478"},{urls:"stun:stun.l.google.com:19302"},{urls:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"},{urls:"turn:turn.anyfirewall.com:443?transport=tcp",credential:"webrtc",username:"webrtc"},{urls:"stun:stun.services.mozilla.com"}]},peerConnectionConstraints:{optional:[{DtlsSrtpKeyAgreement:!0}]}},peerDatabase={},remoteStreamsDB={},remoteVideosContainer=document.getElementById("remoteVideosContainer"),socket=io(),externalMechanisms={};return socket.on("message",handleMessage),socket.on("id",function(id){localId=id,console.log("<--- Local ID: ",localId," --->")}),socket.on("streamNotification",function(res){if(console.log("<--- stream notification --->"),console.log(res),externalMechanisms.hasOwnProperty("load_data")){if("stream_off"===res.notification_key){var remote_id=res.client_id_from,peer=peerDatabase[remote_id];try{remoteVideosContainer&&remoteVideosContainer.hasChildNodes()&&remoteVideosContainer.contains(peer.remoteVideosDiv)&&remoteVideosContainer.removeChild(peer.remoteVideosDiv)}catch(err){console.log(err)}}externalMechanisms.load_data(),console.log("streamNotification: update stream list...")}}),socket.on("watcherNotification",function(res){console.log("<--- watcher notification --->"),console.log(res),externalMechanisms.hasOwnProperty("load_watchers")&&(console.log("watcherNotification: update watcher list..."),externalMechanisms.load_watchers())}),{getId:function(){return localId},setLocalStream:function(stream){if(!stream)for(var id in peerDatabase){var pc=peerDatabase[id].pc;pc.getLocalStreams().length&&(pc.removeStream(localStream),offer(id))}localStream=stream},toggleLocalStream:function(remoteId){var peer=peerDatabase[remoteId]||addPeer(remoteId,userType);toggleLocalStream(peer.pc)},localPeerInit:function(){window.localPeer||(window.localPeer=initLocalPeer())},peerInit:function(remoteId){var peer=peerDatabase[remoteId]||addPeer(remoteId,userType);return send("init",remoteId,null),peer},peerRenegociate:function(remoteId){offer(remoteId)},send:function(type,payload){socket.emit(type,payload)},removeStream:function(remoteId){peerDatabase[remoteId];send("remove",remoteId,null)},addExternalMechanism:function(arg_mechanism_name,arg_mechanism){externalMechanisms[arg_mechanism_name]=arg_mechanism},getRemoteStreamsDB:function(){return remoteStreamsDB}}},Peer=function(pcConfig,pcConstraints){this.pc=new RTCPeerConnection(pcConfig,pcConstraints)},LocalPeer=function(pcConfig,pcConstraints){Peer.call(this,pcConfig,pcConstraints)},RemotePeer=function(pcConfig,pcConstraints,arg_remote_id,arg_usertype){Peer.call(this,pcConfig,pcConstraints),this.remoteVideoEl=document.createElement("video"),this.remoteVideoEl.controls=!0,this.remoteVideoEl.autoplay=!0,this.remoteVideoEl.muted=!0,this.remoteVideoEl.id=arg_remote_id,this.remoteVideosDiv=document.createElement("div"),this.remoteVideosDiv.className="remoteVideosDiv",this.remoteVideosDiv.id=arg_remote_id,this.remoteVideosDiv.appendChild(document.createElement("hr")),this.remoteVideosDiv.appendChild(this.remoteVideoEl),this.remoteVideosDiv.appendChild(document.createElement("br")),"broadcast"===arg_usertype&&(this.startRecordingBtn=document.createElement("input"),this.stopRecordingBtn=document.createElement("input"),this.startRecordingBtn.setAttribute("type","button"),this.stopRecordingBtn.setAttribute("type","button"),this.startRecordingBtn.className="col-sm-6 col-xs-12 btn btn-default",this.stopRecordingBtn.className="col-sm-6 col-xs-12 btn btn-default",this.startRecordingBtn.setAttribute("value","Start Recording"),this.stopRecordingBtn.setAttribute("value","Stop Recording"),this.stopRecordingBtn.setAttribute("disabled",!0),this.remoteVideosDiv.appendChild(this.startRecordingBtn),this.remoteVideosDiv.appendChild(this.stopRecordingBtn))};